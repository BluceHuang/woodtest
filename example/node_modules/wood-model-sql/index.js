/**
 * Wood Plugin Module.
 * 数据模型
 * by jlego on 2018-11-18
 */
const Model = require('./src/model');
const Sequelize = require('sequelize');
const { catchErr, error } = require('wood-util')();
const Redis = require('wood-redis')();

module.exports = (app, config = {}) => {
  const { Util } = require('wood-util')(app);
  const { Redis } = require('wood-redis')(app);
  const { Mysql } = require('wood-mysql')(app);
  app._models = new Map();
  app.Model = function(_tableName, options) {
    let nameArr = _tableName.split('.'),
      dbName = nameArr.length > 1 ? nameArr[0] : 'master',
      tableName = nameArr.length > 1 ? nameArr[1] : nameArr[0];
    if(tableName){
      if(app._models.has(tableName)){
        let _model = app._models.get(tableName);
        if(_model) _model.resetData();
        return _model;
      }
      if (tableName) {
        let theModel = new Model({
          tableName,
          options
        });

        try {
          theModel.redis = new Redis(tableName);
          theModel.db = new Mysql(tableName, dbName);
          app._models.set(tableName, theModel);
          theModel._init();
        } catch (err) {
          console.log(err);
        }
        return app._models.get(tableName);
      }
    }
    return Model;
  };
  
  
  if(app.addAppProp) {
    app.addAppProp('Model', app.Model);
    app.addAppProp('DataTypes', Sequelize.DataTypes);
  }
  return app;
}
